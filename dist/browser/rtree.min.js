(function(e,t){typeof module=="object"&&typeof module.exports=="object"&&(exports=module.exports=t()),typeof define=="function"&&define.amd&&define(t),typeof window=="object"&&(typeof e.Terraformer=="undefined"&&(e.Terraformer={}),e.Terraformer.RTree=t())})(this,function(){var e={},t=function(e){var n=3,r=6;isNaN(e)||(n=Math.floor(e/2),r=e);var i={x:0,y:0,w:0,h:0,id:"root",nodes:[]},s=function(){var e={};return function(t){var n=0;return t in e?n=e[t]++:e[t]=0,t+"_"+n}}();t.Rectangle.squarified_ratio=function(e,t,n){var r=(e+t)/2,i=e*t,s=i/(r*r);return i*n/s};var o=function(e,r,i){var s=[],o=[],u=[],a=1;if(!e||!t.Rectangle.overlap_rectangle(e,i))return u;var f={x:e.x,y:e.y,w:e.w,h:e.h,target:r};o.push(i.nodes.length),s.push(i);do{var l=s.pop(),c=o.pop()-1;if("target"in f)while(c>=0){var d=l.nodes[c];if(t.Rectangle.overlap_rectangle(f,d)){if(f.target&&"leaf"in d&&d.leaf===f.target||!f.target&&("leaf"in d||t.Rectangle.contains_rectangle(d,f))){"nodes"in d?(u=h(d,!0,[],d),l.nodes.splice(c,1)):u=l.nodes.splice(c,1),t.Rectangle.make_MBR(l.nodes,l),delete f.target,l.nodes.length<n&&(f.nodes=h(l,!0,[],l));break}"nodes"in d&&(a+=1,o.push(c),s.push(l),l=d,c=d.nodes.length)}c-=1}else if("nodes"in f){l.nodes.splice(c+1,1),l.nodes.length>0&&t.Rectangle.make_MBR(l.nodes,l);for(var v=0;v<f.nodes.length;v++)p(f.nodes[v],l);f.nodes.length=0,s.length===0&&l.nodes.length<=1?(f.nodes=h(l,!0,f.nodes,l),l.nodes.length=0,s.push(l),o.push(1)):s.length>0&&l.nodes.length<n?(f.nodes=h(l,!0,f.nodes,l),l.nodes.length=0):delete f.nodes}else t.Rectangle.make_MBR(l.nodes,l);a-=1}while(s.length>0);return u},u=function(e,n){var r=-1,i=[],s,o=function(e,t){return function(n){e._attach_data(t,n)}};i.push(n);var u=n.nodes;do{r!==-1&&(i.push(u[r]),u=u[r].nodes,r=-1);for(var a=u.length-1;a>=0;a--){var f=u[a];if("leaf"in f){r=-1;break}var l=t.Rectangle.squarified_ratio(f.w,f.h,f.nodes.length+1),c=Math.max(f.x+f.w,e.x+e.w)-Math.min(f.x,e.x),h=Math.max(f.y+f.h,e.y+e.h)-Math.min(f.y,e.y),p=t.Rectangle.squarified_ratio(c,h,f.nodes.length+2);if(r<0||Math.abs(p-l)<s)s=Math.abs(p-l),r=a}}while(r!==-1);return i},a=function(e){var t=l(e);while(e.length>0)f(e,t[0],t[1]);return t},f=function(e,r,i){var s=t.Rectangle.squarified_ratio(r.w,r.h,r.nodes.length+1),o=t.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),u,a,f;for(var l=e.length-1;l>=0;l--){var c=e[l],h={};h.x=Math.min(r.x,c.x),h.y=Math.min(r.y,c.y),h.w=Math.max(r.x+r.w,c.x+c.w)-h.x,h.h=Math.max(r.y+r.h,c.y+c.h)-h.y;var p=Math.abs(t.Rectangle.squarified_ratio(h.w,h.h,r.nodes.length+2)-s),d={};d.x=Math.min(i.x,c.x),d.y=Math.min(i.y,c.y),d.w=Math.max(i.x+i.w,c.x+c.w)-d.x,d.h=Math.max(i.y+i.h,c.y+c.h)-d.y;var v=Math.abs(t.Rectangle.squarified_ratio(d.w,d.h,i.nodes.length+2)-o);if(!a||!u||Math.abs(v-p)<u)a=l,u=Math.abs(v-p),f=v<p?i:r}var m=e.splice(a,1)[0];r.nodes.length+e.length+1<=n?(r.nodes.push(m),t.Rectangle.expand_rectangle(r,m)):i.nodes.length+e.length+1<=n?(i.nodes.push(m),t.Rectangle.expand_rectangle(i,m)):(f.nodes.push(m),t.Rectangle.expand_rectangle(f,m))},l=function(e){var t=e.length-1,n=0,r=e.length-1,i=0,s,o;for(var u=e.length-2;u>=0;u--){var a=e[u];a.x>e[n].x?n=u:a.x+a.w<e[t].x+e[t].w&&(t=u),a.y>e[i].y?i=u:a.y+a.h<e[r].y+e[r].h&&(r=u)}var f=Math.abs(e[t].x+e[t].w-e[n].x),l=Math.abs(e[r].y+e[r].h-e[i].y);return f>l?t>n?(s=e.splice(t,1)[0],o=e.splice(n,1)[0]):(o=e.splice(n,1)[0],s=e.splice(t,1)[0]):r>i?(s=e.splice(r,1)[0],o=e.splice(i,1)[0]):(o=e.splice(i,1)[0],s=e.splice(r,1)[0]),[{x:s.x,y:s.y,w:s.w,h:s.h,nodes:[s]},{x:o.x,y:o.y,w:o.w,h:o.h,nodes:[o]}]},c=function(e,t){return e.nodes=t.nodes,e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e},h=function(e,n,r,i,s){var o=[];if(!t.Rectangle.overlap_rectangle(e,i)){if(!s)return r;s(null,r)}var u=function(e,t){return function(n){e._attach_data(t,n)}};o.push(i.nodes);do{var a=o.pop();for(var f=a.length-1;f>=0;f--){var l=a[f];t.Rectangle.overlap_rectangle(e,l)&&("nodes"in l?o.push(l.nodes):"leaf"in l&&(n?r.push(l):r.push(l.leaf)))}}while(o.length>0);if(!s)return r;s(null,r)},p=function(e,n){var i;if(n.nodes.length===0){n.x=e.x,n.y=e.y,n.w=e.w,n.h=e.h,n.nodes.push(e);return}var s=u(e,n),o=e;do{if(i&&"nodes"in i&&i.nodes.length===0){var f=i;i=s.pop();for(var l=0;l<i.nodes.length;l++)if(i.nodes[l]===f||i.nodes[l].nodes.length===0){i.nodes.splice(l,1);break}}else i=s.pop();if("leaf"in o||"nodes"in o||Array.isArray(o)){if(Array.isArray(o)){for(var c=0;c<o.length;c++)t.Rectangle.expand_rectangle(i,o[c]);i.nodes=i.nodes.concat(o)}else t.Rectangle.expand_rectangle(i,o),i.nodes.push(o);if(i.nodes.length<=r)o={x:i.x,y:i.y,w:i.w,h:i.h};else{var h=a(i.nodes);o=h,s.length<1&&(i.nodes.push(h[0]),s.push(i),o=h[1])}}else t.Rectangle.expand_rectangle(i,o),o={x:i.x,y:i.y,w:i.w,h:i.h}}while(s.length>0)};this.serialize=function(){return i},this.deserialize=function(e,t){return t||(t=i),c(t,e)},this.search=function(e,t){var n=[e,!1,[],i,t];if(e===undefined)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";if(!t)return h.apply(this,n);h.apply(this,n)},this.toJSON=function(e,n){var r=[],o=[],u={},a=3,f=1,l="";if(e&&!t.Rectangle.overlap_rectangle(e,i))return"";n?(a+=4,o.push(n.nodes.length),r.push(n.nodes),l+="var main_tree = {x:"+n.x.toFixed()+",y:"+n.y.toFixed()+",w:"+n.w.toFixed()+",h:"+n.h.toFixed()+",nodes:["):(o.push(i.nodes.length),r.push(i.nodes),l+="var main_tree = {x:"+i.x.toFixed()+",y:"+i.y.toFixed()+",w:"+i.w.toFixed()+",h:"+i.h.toFixed()+",nodes:[");do{var c=r.pop(),h=o.pop()-1;h>=0&&h<c.length-1&&(l+=",");while(h>=0){var p=c[h];if(!e||t.Rectangle.overlap_rectangle(e,p))if(p.nodes)if(f>=a){var d=u.length,v=s("saved_subtree");l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",load:'"+v+".js'}",u[v]=this.toJSON(e,p),h>0&&(l+=",")}else l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",nodes:[",f+=1,o.push(h),r.push(c),c=p.nodes,h=p.nodes.length;else if(p.leaf){var m=p.leaf.toJSON?p.leaf.toJSON():JSON.stringify(p.leaf);l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",leaf:"+m+"}",h>0&&(l+=",")}else p.load&&(l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",load:'"+p.load+"'}",h>0&&(l+=","));h-=1}h<0&&(l+="]}",f-=1)}while(r.length>0);l+=";";for(var g in u)l+="\nvar "+g+" = function(){"+u[g]+" return(main_tree);};";return l},this.remove=function(e,t){var n=Array.prototype.slice.call(arguments);if(n.length<1)throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle.";switch(n.length){case 1:n[1]=!1,n[2]=i;break;case 2:n[2]=i}n.length=3;if(n[1]===!1){var r=0,s=[];do r=s.length,s=s.concat(o.apply(this,n));while(r!==s.length);return s}return o.apply(this,n)},this.insert=function(e,t){if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle and an object.";return p({x:e.x,y:e.y,w:e.w,h:e.h,leaf:t},i)}};return t.Rectangle=function(e,t,n,r){var i,s,o,u,a,f;e.x?(i=e.x,o=e.y,e.w!==0&&!e.w&&e.x2?(a=e.x2-e.x,f=e.y2-e.y):(a=e.w,f=e.h),s=i+a,u=o+f):(i=e,o=t,a=n,f=r,s=i+a,u=o+f),this.x1=this.x=function(){return i},this.y1=this.y=function(){return o},this.x2=function(){return s},this.y2=function(){return u},this.w=function(){return a},this.h=function(){return f},this.toJSON=function(){return'{"x":'+i.toString()+', "y":'+o.toString()+', "w":'+a.toString()+', "h":'+f.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var t=Math.min(this.x(),e.x()),n=Math.min(this.y(),e.y());return a=Math.max(this.x2(),e.x2())-t,f=Math.max(this.y2(),e.y2())-n,i=t,o=n,this},this.setRect=function(e,t,n,r){var i,s,o,u,a,f;e.x?(i=e.x,o=e.y,e.w!==0&&!e.w&&e.x2?(a=e.x2-e.x,f=e.y2-e.y):(a=e.w,f=e.h),s=i+a,u=o+f):(i=e,o=t,a=n,f=r,s=i+a,u=o+f)}},t.Rectangle.overlap_rectangle=function(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},t.Rectangle.contains_rectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},t.Rectangle.expand_rectangle=function(e,t){var n,r;return e.x<t.x?n=e.x:n=t.x,e.y<t.y?r=e.y:r=t.y,e.x+e.w>t.x+t.w?e.w=e.x+e.w-n:e.w=t.x+t.w-n,e.y+e.h>t.y+t.h?e.h=e.y+e.h-r:e.h=t.y+t.h-r,e.x=n,e.y=r,e},t.Rectangle.make_MBR=function(e,n){if(e.length<1)return{x:0,y:0,w:0,h:0};n?(n.x=e[0].x,n.y=e[0].y,n.w=e[0].w,n.h=e[0].h):n={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h};for(var r=e.length-1;r>0;r--)t.Rectangle.expand_rectangle(n,e[r]);return n},e.RTree=t,e});