!function(a,b){if("object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b(require("terraformer"))),"object"==typeof a.navigator){if(!a.Terraformer)throw new Error("Terraformer.RTree requires the core Terraformer library. https://github.com/esri/Terraformer");a.Terraformer.RTree=b(a.Terraformer).RTree}}(this,function(a){function b(a){return"[object Array]"===Object.prototype.toString.call(a)}var c={},d=function(c){var e=3,f=6;isNaN(c)||(e=Math.floor(c/2),f=c),this.min_width=e,this.max_width=f;var g={x:0,y:0,w:0,h:0,id:"root",nodes:[]};!function(){var a={};return function(b){var c=0;return b in a?c=a[b]++:a[b]=0,b+"_"+c}}(),d.Rectangle.squarified_ratio=function(a,b,c){var d=(a+b)/2,e=a*b,f=e/(d*d);return e*c/f};var h=function(a,b,c){var f=[],g=[],h=[],i=1;if(!a||!d.Rectangle.overlap_rectangle(a,c))return h;var j={x:a.x,y:a.y,w:a.w,h:a.h,target:b};g.push(c.nodes.length),f.push(c);do{var k=f.pop(),l=g.pop()-1;if("target"in j)for(;l>=0;){var m=k.nodes[l];if(d.Rectangle.overlap_rectangle(j,m)){if(j.target&&"leaf"in m&&m.leaf===j.target||!j.target&&("leaf"in m||d.Rectangle.contains_rectangle(m,j))){"nodes"in m?(h=n(m,!0,[],m),k.nodes.splice(l,1)):h=k.nodes.splice(l,1),d.Rectangle.make_MBR(k.nodes,k),delete j.target,k.nodes.length<e&&(j.nodes=n(k,!0,[],k));break}"nodes"in m&&(i+=1,g.push(l),f.push(k),k=m,l=m.nodes.length)}l-=1}else if("nodes"in j){k.nodes.splice(l+1,1),k.nodes.length>0&&d.Rectangle.make_MBR(k.nodes,k);for(var o=0;o<j.nodes.length;o++)p(j.nodes[o],k);j.nodes.length=0,0===f.length&&k.nodes.length<=1?(j.nodes=n(k,!0,j.nodes,k),k.nodes.length=0,f.push(k),g.push(1)):f.length>0&&k.nodes.length<e?(j.nodes=n(k,!0,j.nodes,k),k.nodes.length=0):delete j.nodes}else d.Rectangle.make_MBR(k.nodes,k);i-=1}while(f.length>0);return h},i=function(a,b){var c,e=-1,f=[];f.push(b);var g=b.nodes;do{-1!==e&&(f.push(g[e]),g=g[e].nodes,e=-1);for(var h=g.length-1;h>=0;h--){var i=g[h];if("leaf"in i){e=-1;break}var j=d.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),k=Math.max(i.x+i.w,a.x+a.w)-Math.min(i.x,a.x),l=Math.max(i.y+i.h,a.y+a.h)-Math.min(i.y,a.y),m=d.Rectangle.squarified_ratio(k,l,i.nodes.length+2);(0>e||Math.abs(m-j)<c)&&(c=Math.abs(m-j),e=h)}}while(-1!==e);return f},j=function(a){for(var b=l(a);a.length>0;)k(a,b[0],b[1]);return b},k=function(a,b,c){for(var f,g,h,i=d.Rectangle.squarified_ratio(b.w,b.h,b.nodes.length+1),j=d.Rectangle.squarified_ratio(c.w,c.h,c.nodes.length+1),k=a.length-1;k>=0;k--){var l=a[k],m={};m.x=Math.min(b.x,l.x),m.y=Math.min(b.y,l.y),m.w=Math.max(b.x+b.w,l.x+l.w)-m.x,m.h=Math.max(b.y+b.h,l.y+l.h)-m.y;var n=Math.abs(d.Rectangle.squarified_ratio(m.w,m.h,b.nodes.length+2)-i),o={};o.x=Math.min(c.x,l.x),o.y=Math.min(c.y,l.y),o.w=Math.max(c.x+c.w,l.x+l.w)-o.x,o.h=Math.max(c.y+c.h,l.y+l.h)-o.y;var p=Math.abs(d.Rectangle.squarified_ratio(o.w,o.h,c.nodes.length+2)-j);(!g||!f||Math.abs(p-n)<f)&&(g=k,f=Math.abs(p-n),h=n>p?c:b)}var q=a.splice(g,1)[0];b.nodes.length+a.length+1<=e?(b.nodes.push(q),d.Rectangle.expand_rectangle(b,q)):c.nodes.length+a.length+1<=e?(c.nodes.push(q),d.Rectangle.expand_rectangle(c,q)):(h.nodes.push(q),d.Rectangle.expand_rectangle(h,q))},l=function(a){for(var b,c,d=a.length-1,e=0,f=a.length-1,g=0,h=a.length-2;h>=0;h--){var i=a[h];i.x>a[e].x?e=h:i.x+i.w<a[d].x+a[d].w&&(d=h),i.y>a[g].y?g=h:i.y+i.h<a[f].y+a[f].h&&(f=h)}var j=Math.abs(a[d].x+a[d].w-a[e].x),k=Math.abs(a[f].y+a[f].h-a[g].y);return j>k?d>e?(b=a.splice(d,1)[0],c=a.splice(e,1)[0]):(c=a.splice(e,1)[0],b=a.splice(d,1)[0]):f>g?(b=a.splice(f,1)[0],c=a.splice(g,1)[0]):(c=a.splice(g,1)[0],b=a.splice(f,1)[0]),[{x:b.x,y:b.y,w:b.w,h:b.h,nodes:[b]},{x:c.x,y:c.y,w:c.w,h:c.h,nodes:[c]}]},m=function(a,b){return a.nodes=b.nodes,a.x=b.x,a.y=b.y,a.w=b.w,a.h=b.h,a},n=function(a,b,c,e){var f=[];if(!d.Rectangle.overlap_rectangle(a,e))return c;f.push(e.nodes);do for(var g=f.pop(),h=g.length-1;h>=0;h--){var i=g[h];d.Rectangle.overlap_rectangle(a,i)&&("nodes"in i?f.push(i.nodes):"leaf"in i&&(b?c.push(i):c.push(i.leaf)))}while(f.length>0);return c},o=function(a,b,c,e){var f=[];if(!d.Rectangle.overlap_rectangle(e,a))return c;f.push(e.nodes);do for(var g=f.pop(),h=g.length-1;h>=0;h--){var i=g[h];d.Rectangle.overlap_rectangle(i,a)&&("nodes"in i?f.push(i.nodes):"leaf"in i&&(b?c.push(i):c.push(i.leaf)))}while(f.length>0);return c},p=function(a,c){var e;if(0===c.nodes.length)return c.x=a.x,c.y=a.y,c.w=a.w,c.h=a.h,c.nodes.push(a),void 0;var g=i(a,c),h=a;do{if(e&&"nodes"in e&&0===e.nodes.length){var k=e;e=g.pop();for(var l=0;l<e.nodes.length;l++)if(e.nodes[l]===k||0===e.nodes[l].nodes.length){e.nodes.splice(l,1);break}}else e=g.pop();if("leaf"in h||"nodes"in h||b(h)){if(b(h)){for(var m=0;m<h.length;m++)d.Rectangle.expand_rectangle(e,h[m]);e.nodes=e.nodes.concat(h)}else d.Rectangle.expand_rectangle(e,h),e.nodes.push(h);if(e.nodes.length<=f)h={x:e.x,y:e.y,w:e.w,h:e.h};else{var n=j(e.nodes);h=n,g.length<1&&(e.nodes.push(n[0]),g.push(e),h=n[1])}}else d.Rectangle.expand_rectangle(e,h),h={x:e.x,y:e.y,w:e.w,h:e.h}}while(g.length>0)};this.serialize=function(a){a(null,g)},this.deserialize=function(a,b,c){var d=Array.prototype.slice.call(arguments);switch(d.length){case 1:b=g;break;case 2:"function"==typeof d[1]&&(b=g,c=d[1])}var e=m(b,a);c&&c(null,e)},this.search=function(b,c){var d;if(b.type){var e=a.Tools.calculateBounds(b);d={x:e[0],y:e[1],w:Math.abs(e[0]-e[2]),h:Math.abs(e[1]-e[3])}}else d=b;var f=[d,!1,[],g];if(void 0===d)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";var h=n.apply(this,f);c&&c(null,h)},this.within=function(b,c){var d;if(b.type){var e=a.Tools.calculateBounds(b);d={x:e[0],y:e[1],w:Math.abs(e[0]-e[2]),h:Math.abs(e[1]-e[3])}}else d=b;var f=[d,!1,[],g];if(void 0===d)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";var h=o.apply(this,f);c&&c(null,h)},this.remove=function(b,c,d){var e=Array.prototype.slice.call(arguments);if(1===e.length&&e.push(!1),3===e.length&&(d=e.pop()),e&&e[0]&&e[0].type){var f=a.Tools.calculateBounds(e[0]);e[0]={x:f[0],y:f[1],w:Math.abs(f[0]-f[2]),h:Math.abs(f[1]-f[3])}}if(e.push(g),c===!1){var i=0,j=[];do i=j.length,j=j.concat(h.apply(this,e));while(i!==j.length);d&&d(null,j)}else{var k=h.apply(this,e);d&&d(null,k)}},this.insert=function(b,c,d){var e;if(b.type){var f=a.Tools.calculateBounds(b);e={x:f[0],y:f[1],w:Math.abs(f[0]-f[2]),h:Math.abs(f[1]-f[3])}}else e=b;if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle or GeoJSON and an object.";var h=p({x:e.x,y:e.y,w:e.w,h:e.h,leaf:c},g);d&&d(null,h)}};return d.Rectangle=function(a,b,c,d){var e,f,g,h,i,j;a.x?(e=a.x,g=a.y,0!==a.w&&!a.w&&a.x2?(i=a.x2-a.x,j=a.y2-a.y):(i=a.w,j=a.h),f=e+i,h=g+j):(e=a,g=b,i=c,j=d,f=e+i,h=g+j),this.x1=this.x=function(){return e},this.y1=this.y=function(){return g},this.x2=function(){return f},this.y2=function(){return h},this.w=function(){return i},this.h=function(){return j},this.toJSON=function(){return'{"x":'+e.toString()+', "y":'+g.toString()+', "w":'+i.toString()+', "h":'+j.toString()+"}"},this.overlap=function(a){return this.x()<a.x2()&&this.x2()>a.x()&&this.y()<a.y2()&&this.y2()>a.y()},this.expand=function(a){var b=Math.min(this.x(),a.x()),c=Math.min(this.y(),a.y());return i=Math.max(this.x2(),a.x2())-b,j=Math.max(this.y2(),a.y2())-c,e=b,g=c,this},this.setRect=function(a,b,c,d){var e,f,g,h,i,j;a.x?(e=a.x,g=a.y,0!==a.w&&!a.w&&a.x2?(i=a.x2-a.x,j=a.y2-a.y):(i=a.w,j=a.h),f=e+i,h=g+j):(e=a,g=b,i=c,j=d,f=e+i,h=g+j)}},d.Rectangle.overlap_rectangle=function(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y},d.Rectangle.contains_rectangle=function(a,b){return a.x+a.w<=b.x+b.w&&a.x>=b.x&&a.y+a.h<=b.y+b.h&&a.y>=b.y},d.Rectangle.expand_rectangle=function(a,b){var c,d;return c=a.x<b.x?a.x:b.x,d=a.y<b.y?a.y:b.y,a.w=a.x+a.w>b.x+b.w?a.x+a.w-c:b.x+b.w-c,a.h=a.y+a.h>b.y+b.h?a.y+a.h-d:b.y+b.h-d,a.x=c,a.y=d,a},d.Rectangle.make_MBR=function(a,b){if(a.length<1)return{x:0,y:0,w:0,h:0};b?(b.x=a[0].x,b.y=a[0].y,b.w=a[0].w,b.h=a[0].h):b={x:a[0].x,y:a[0].y,w:a[0].w,h:a[0].h};for(var c=a.length-1;c>0;c--)d.Rectangle.expand_rectangle(b,a[c]);return b},c.RTree=d,c});